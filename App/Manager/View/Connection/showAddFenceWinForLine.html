<!--添加电子围栏-->

<div >

    <div style="padding-left: 10%;padding-top: 16px;width: 80%;text-align: left">
        <span style="margin-right: 12px;">路线名称</span>
        <input id="fence_name" required="true" style="width: 40%;"/>
    </div>
    <div style="padding-left: 10%;padding-top: 16px;width: 80%;text-align: left">
        <span style="margin-right: 12px;">路线类型</span>
        <!--<input id="fence_type" style="width: 80%;"/>-->
        <select id="fence_type"  class="easyui-combobox" data-options="editable:false"
                style="width:40%;">
            <option value="1">自定义</option>
            <option value="2">国道</option>
            <option value="3">省道</option>
            <option value="4">县道</option>
            <option value="5">高速</option>
            <option value="6">高架立交</option>
            <option value="7">其他小路</option>

        </select>
    </div>
    <div style="padding-left: 10%;padding-top: 16px;width: 80%;text-align: left">
        <span style="margin-right: 12px;">路线宽度</span>
        <input id = "fence_width" class="easyui-numberspinner" data-options="min:1,max:1000,editable:true" value="50"
               style="width: 40%;"/>（米）
    </div>

    <div style="padding-left: 10%;padding-top: 16px;width: 80%;text-align: left">
        <span style="margin-right: 12px;">备注</span><br>
        <textarea id="fence_comments" style="margin-left:60px;width: 60%;height: 60px"/>
    </div>
    <span style="padding-top: 16px;margin-right: 12px;padding-left: 10%;width: 80%;">路线数据</span>
    <div style="padding-left: 10%;padding-top:4px;width: 80%;text-align: center" >
        <table id="fence_rect_grid" class="easyui-datagrid">
        </table>
    </div>

    <div style="padding-left: 10%;padding-top:4px;width: 80%;text-align: center" >
        <button onclick="saveRectFence()">保存</button>
        <button onclick="closeWindows()">关闭</button>
    </div>
</div>

<script>

    function initFenceGrid(){
//        构建点
        var rows = [];
        for(var i=0;i<currFenceDatas.length;i++){
            rows.push({
                operate:'<a href="#" onclick="del('+i+')">'+'移除</>',
                lat:currFenceDatas[i].y.toFixed(6),
                lng:currFenceDatas[i].x.toFixed(6)
            });
        }
        console.log(JSON.stringify(rows));
//        添加移除点的功能
        $('#fence_rect_grid').datagrid({
            fitColumns:true,
            striped:true,
            rownumbers:true,
            data:{
                total:rows.length,
                rows:rows,
            },
            columns:[[
                {field:'operate',title:'操作',width:40},
                {field:'lng',title:'经度',width:120},
                {field:'lat',title:'纬度',width:120},
            ]]
        });

    }
    function closeWindows() {
        currFenceDatas = null;
        $( <?php echo"'#".$windowId."'";?>).window('close');
    }
    function saveRectFence(){
//        获取参数，并添加到数据库中。

//        1.获取各个参数，
//        2.校验
//        3.上传。

        var rows = $('#fence_rect_grid').datagrid('getData').rows;
        var datas = [];
        for (key in rows){
            datas.push({"lat":rows[key].lat,"lng":rows[key].lng});
        }
        var dataJsonString = JSON.stringify(datas);
        var title = $('#fence_name').val();
        var type = $('#fence_type').combobox('getValue');
        var comments = $('#fence_comments').val();
        var width = $('#fence_width').val();

        if (!dataJsonString ){
            showTipsMessage("数据有误，请重新添加！");
            closeWindows();
        }
        if(!title){
            showTipsMessage("名称不能为空，请先录入名称！");
            return;
        }

        $.ajax({
            url: "{:U('Manager/Connection/addFenceForLine')}",
            data: {"title": title, "datas": dataJsonString, "type": type,"comments":comments,"width":width},
            type: 'POST',
            success: function (response) {
                console.log("收到的是：",response);
                showTipsMessage('添加路线围栏成功！');
                closeWindows();
            },
            error: function(){
                showTipsMessage('添加路线围栏失败！请稍后再试！');
                closeWindows();
            }
        });

    }

    function del(index){
        if($('#fence_rect_grid').datagrid('getData').total > 2){
            $('#fence_rect_grid').datagrid('deleteRow',index);
        }else{
            showTipsMessage("不能少于2个点"+$('#fence_rect_grid').datagrid('getData').total);
        }
    }

    initFenceGrid();
</script>